name: "Triple Backend Compiler — Full Automation + Release Upload"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write    # release 업로드에 필요
  actions: write
  packages: write

concurrency:
  group: triple-backend-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-3os:
    name: "3 Backend Build — ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # -------------------------------------------------------------
      # 1) Checkout
      # -------------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # 2) Rust Setup
      # -------------------------------------------------------------
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # -------------------------------------------------------------
      # 3) CMake + Build Tools
      # -------------------------------------------------------------
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: Install Build Tools (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y g++ nasm

      - name: Install Build Tools (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install nasm

      - name: Install Build Tools (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install nasm -y

      # -------------------------------------------------------------
      # 4) Rust Frontend → IR
      # -------------------------------------------------------------
      - name: Generate IR
        run: |
          cargo run --bin frontend -- --emit-ir ir_output.json

      # -------------------------------------------------------------
      # 5) Pure-rust-no-llvm Backend → ASM
      # -------------------------------------------------------------
      - name: PureRust Backend → ASM
        run: |
          cargo run --bin pure_backend ir_output.json pure_rust_output.asm

      # -------------------------------------------------------------
      # 6) C++ MetaNasm Backend
      # -------------------------------------------------------------
      - name: Generate C++ MetaAST Header
        run: |
          cargo run --bin meta_bridge ir_output.json bridge/generated_meta_ast.hpp

      - name: Configure meta_nasm
        run: |
          cd meta_nasm
          mkdir build
          cd build
          cmake ..

      - name: Build meta_nasm
        run: |
          cd meta_nasm/build
          cmake --build . --config Release

      - name: Run meta_nasm (ASM)
        run: |
          cd meta_nasm/build
          ./meta_nasm || meta_nasm.exe

      # -------------------------------------------------------------
      # 7) RustSpec Diff
      # -------------------------------------------------------------
      - name: RustSpec Diff
        run: |
          diff pure_rust_output.asm meta_nasm/build/nasm_output.asm > rustspec_diff.txt || true

      # -------------------------------------------------------------
      # 8) ProofLedger v5
      # -------------------------------------------------------------
      - name: Generate ProofLedger
        run: |
          echo "Repository: ${{ github.repository }}" > proofledger-${{ matrix.os }}.txt
          echo "OS: ${{ matrix.os }}" >> proofledger-${{ matrix.os }}.txt
          echo "Commit: ${{ github.sha }}" >> proofledger-${{ matrix.os }}.txt
          echo "Timestamp: $(date)" >> proofledger-${{ matrix.os }}.txt
          echo "Frontend IR: ir_output.json" >> proofledger-${{ matrix.os }}.txt
          echo "PureRust ASM: pure_rust_output.asm" >> proofledger-${{ matrix.os }}.txt
          echo "MetaNasm ASM: nasm_output.asm" >> proofledger-${{ matrix.os }}.txt
          echo "RustSpec Diff: rustspec_diff.txt" >> proofledger-${{ matrix.os }}.txt
          echo "Triple Backend: PureRust / C++Meta / IR-Bridge" >> proofledger-${{ matrix.os }}.txt

      # -------------------------------------------------------------
      # 9) 아티팩트 업로드
      # -------------------------------------------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.os }}
          path: |
            ir_output.json
            pure_rust_output.asm
            meta_nasm/build/nasm_output.asm
            rustspec_diff.txt
            proofledger-${{ matrix.os }}.txt

  # ---------------------------------------------------------------
  # Release Job (OS별 빌드 끝나면 실행)
  # ---------------------------------------------------------------
  release:
    name: "Release Upload"
    needs: [build-3os]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 자동 태그 생성 (v20251115-1030 이런 형태)
      - name: Generate Release Tag
        id: tag
        run: |
          echo "tag=v$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      # Release 생성
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Triple Backend Compiler — ${{ steps.tag.outputs.tag }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Release 자산 업로드
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: |
            pure_rust_output.asm
            nasm_output.asm
            rustspec_diff.txt
            proofledger-ubuntu-latest.txt
            proofledger-macos-latest.txt
            proofledger-windows-latest.txt
            ir_output.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
